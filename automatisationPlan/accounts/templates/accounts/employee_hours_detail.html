<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails des heures de {{ employee.first_name }} {{ employee.last_name }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .action-btn {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .edit-btn {
            background-color: #007bff;
            color: white;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        .action-btn:hover {
            opacity: 0.8;
        }
        .time-input, .date-input {
            display: none; /* Hide inputs by default */
        }
        .edit-mode .time-input,
        .edit-mode .date-input {
            display: inline-block;
        }
        .edit-mode .time-display,
        .edit-mode .date-display {
            display: none;
        }
        .view-mode .time-display,
        .view-mode .date-display {
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Détails des heures de {{ employee.first_name }} {{ employee.last_name }}</h1>
        <h2>{{ month_display }}</h2>

        {% if messages %}
        <ul class="messages">
            {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Heure de pointage</th>
                    <th>Heure de dépointe</th>
                    <th>Heures travaillées</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="time-clocks-body">
                {% for time_clock in time_clocks %}
                <tr id="row-{{ time_clock.id }}" class="view-mode">
                    <td>
                        <span class="date-display">{{ time_clock.clock_in_time|date:"d/m/Y" }}</span>
                        <input type="date" name="clock_date" value="{{ time_clock.clock_in_time|date:'Y-m-d' }}" class="date-input">
                    </td>
                    <td>
                        <span class="time-display">{{ time_clock.clock_in_time|time:"H:i" }}</span>
                        <input type="time" name="clock_in_time" value="{{ time_clock.clock_in_time|time:'H:i' }}" class="time-input">
                    </td>
                    <td>
                        <span class="time-display">{{ time_clock.clock_out_time|time:"H:i" }}</span>
                        <input type="time" name="clock_out_time" value="{{ time_clock.clock_out_time|time:'H:i' }}" class="time-input">
                    </td>
                    <td>
                        {% if time_clock.clock_out_time %}
                            {{ time_clock.clock_out_time|timeuntil:time_clock.clock_in_time }}
                        {% else %}
                            En cours
                        {% endif %}
                    </td>
                    <td>
                        <button class="action-btn edit-btn" data-id="{{ time_clock.id }}">Modifier</button>
                        <form method="post" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="time_clock_id" value="{{ time_clock.id }}">
                            <input type="hidden" name="action" value="delete">
                            <button type="submit" class="action-btn delete-btn" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet enregistrement ?');">Supprimer</button>
                        
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="text-align: center; margin-top: 20px;">
            <a href="{% url 'manager_employee_hours' %}" class="btn">Retour à la liste des employés</a>
            <button id="add-row-btn" class="btn">Ajouter </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded and parsed');
        
            // Gestionnaire pour le bouton d'ajout de ligne
            document.getElementById('add-row-btn').addEventListener('click', function() {
                console.log('Add row button clicked');
                addNewRow();
            });
        
            // Gestionnaire pour les boutons de modification
            document.querySelectorAll('.edit-btn').forEach(function(button) {
                button.addEventListener('click', function() {
                    console.log('Edit button clicked');
                    var id = this.getAttribute('data-id');
                    console.log('Edit button data-id:', id);
                    toggleEdit(id);
                });
            });
        
            // Gestionnaire pour les boutons de suppression
            document.querySelectorAll('.delete-btn').forEach(function(button) {
                button.addEventListener('click', function() {
                    console.log('Delete button clicked');
                    var id = this.getAttribute('data-id');
                    console.log('Delete button data-id:', id);
                    if (confirm('Êtes-vous sûr de vouloir supprimer cet enregistrement ?')) {
                        deleteTimeClock(id);
                    }
                });
            });
        });
        
        function addNewRow() {
            var tbody = document.querySelector('table tbody');
            var newRow = document.createElement('tr');
            newRow.classList.add('edit-mode');
            newRow.innerHTML = `
                <td><input type="date" name="clock_date" required></td>
                <td><input type="time" name="clock_in_time" required></td>
                <td><input type="time" name="clock_out_time" required></td>
                <td>--</td>
                <td><button class="action-btn save-btn">Enregistrer</button></td>
            `;
            tbody.appendChild(newRow);
            
            newRow.querySelector('.save-btn').addEventListener('click', function() {
                saveNewRow(newRow);
            });
        }
        
        function saveNewRow(row) {
            console.log('Saving new row');
            var clockDate = row.querySelector('input[name="clock_date"]').value;
            var clockInTime = row.querySelector('input[name="clock_in_time"]').value;
            var clockOutTime = row.querySelector('input[name="clock_out_time"]').value;
        
            fetch('{% url "employee_hours_detail" employee.id year month %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: 'clock_in_time=' + encodeURIComponent(clockInTime) + 
                      '&clock_out_time=' + encodeURIComponent(clockOutTime) + 
                      '&clock_date=' + encodeURIComponent(clockDate) + 
                      '&action=edit'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Server response for save:', data);
                if (data.success) {
                    updateRowAfterSave(row, clockDate, clockInTime, clockOutTime, true);
                    alert('Enregistrement ajouté avec succès.');
                } else {
                    alert('Erreur lors de l\'enregistrement des modifications: ' + (data.message || 'Raison inconnue'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur est survenue lors de la sauvegarde: ' + error.message);
            });
        }

        
        
        function toggleEdit(id) {
            console.log('Toggling edit for id:', id);
            var row = document.getElementById('row-' + id);
            if (!row) {
                console.error('Row not found for id:', id);
                return;
            }
            var editBtn = row.querySelector('.edit-btn');
        
            if (row.classList.contains('view-mode')) {
                row.classList.remove('view-mode');
                row.classList.add('edit-mode');
                editBtn.textContent = 'Enregistrer';
                editBtn.onclick = function() { saveChanges(id); };
            } else {
                saveChanges(id);
            }
        }
        
        function saveChanges(id) {
            console.log('Saving changes for id:', id);
            var row = document.getElementById('row-' + id);
            var clockDate = row.querySelector('input[name="clock_date"]').value;
            var clockInTime = row.querySelector('input[name="clock_in_time"]').value;
            var clockOutTime = row.querySelector('input[name="clock_out_time"]').value;
        
            fetch('{% url "employee_hours_detail" employee.id year month %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: 'time_clock_id=' + encodeURIComponent(id) + 
                      '&clock_in_time=' + encodeURIComponent(clockInTime) + 
                      '&clock_out_time=' + encodeURIComponent(clockOutTime) + 
                      '&clock_date=' + encodeURIComponent(clockDate) + 
                      '&action=edit'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Server response for edit:', data);
                if (data.success) {
                    updateRowAfterSave(row, clockDate, clockInTime, clockOutTime);
                    alert('Modifications enregistrées avec succès');
                } else {
                    alert('Erreur lors de l\'enregistrement des modifications: ' + (data.message || 'Raison inconnue'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur est survenue lors de la sauvegarde: ' + error.message);
            });
        }
        

        function updateRowAfterSave(row, clockDate, clockInTime, clockOutTime, isNewRow = false) {
            console.log('Updating row after save');
            row.classList.remove('edit-mode');
            row.classList.add('view-mode');
        
            // Création de la structure pour une nouvelle ligne
            if (isNewRow) {
                row.innerHTML = `
                    <td><span class="date-display"></span></td>
                    <td><span class="time-display"></span></td>
                    <td><span class="time-display"></span></td>
                    <td></td>
                    <td>
                        <button class="action-btn edit-btn" data-id="${row.id}">Modifier</button>
                        <button class="action-btn delete-btn" data-id="${row.id}">Supprimer</button>
                    </td>
                `;
            }
        
            var dateDisplay = row.querySelector('.date-display');
            var timeDisplays = row.querySelectorAll('.time-display');
            var totalHoursCell = row.querySelector('td:nth-child(4)');
        
            if (dateDisplay) {
                dateDisplay.textContent = new Date(clockDate).toLocaleDateString();
            } else {
                console.warn('Date display element not found');
            }
        
            if (timeDisplays.length >= 2) {
                timeDisplays[0].textContent = clockInTime;
                timeDisplays[1].textContent = clockOutTime;
            } else {
                console.warn('Time display elements not found');
            }
        
            if (totalHoursCell) {
                var start = new Date("1970-01-01T" + clockInTime + "Z");
                var end = new Date("1970-01-01T" + clockOutTime + "Z");
                var diff = (end - start) / 1000 / 3600;
                totalHoursCell.textContent = diff.toFixed(2) + ' heures';
            } else {
                console.warn('Total hours cell not found');
            }
            
            var editBtn = row.querySelector('.edit-btn') || row.querySelector('.save-btn');
            if (editBtn) {
                editBtn.textContent = 'Modifier';
                editBtn.className = 'action-btn edit-btn';
                editBtn.addEventListener('click', function() {
                    toggleEdit(this.getAttribute('data-id'));
                });
            } else {
                console.warn('Edit button not found');
            }
        
            if (isNewRow) {
                var deleteBtn = row.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        if (confirm('Êtes-vous sûr de vouloir supprimer cet enregistrement ?')) {
                            deleteTimeClock(this.getAttribute('data-id'));
                        }
                    });
                } else {
                    console.warn('Delete button not found');
                }
            }
        }
    </script>
</body>
</html>
